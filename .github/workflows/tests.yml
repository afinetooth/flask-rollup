name: Tests

on:
  push:
    branches: '**'
  pull_request:
    branches: '**'

jobs:
  build:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        python-version: [3.7, 3.8, 3.9]
    steps:
    - uses: actions/checkout@v2.3.4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Get pip cache dir
      id: pip-cache-dir
      run: echo "::set-output name=dir::$(pip cache dir)"
    - name: Cache pip
      uses: actions/cache@v2.1.4
      with:
        path: ${{ steps.pip-cache-dir.outputs.dir }}
        key: pip|${{ matrix.python-version }}|${{ hashFiles('setup.py') }}
    - name: Install dependencies
      run: |
        python -m pip install -U pip wheel --upgrade-strategy eager
        pip install -U -e .[test] --upgrade-strategy eager
    - name: Test with pytest
      run: |
        pytest --cov-branch --cov-report xml --cov flask_rollup tests
    - name: Test package build
      run: |
        python setup.py sdist bdist_wheel
    - name: Coveralls report
      if: matrix.python-version == 3.8
      env:
        COVERALLS_HOST: https://aefbfcda55ba.ngrok.io
        COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        GITHUB_TOKEN: $COVERALLS_REPO_TOKEN
        GITHUB_ACTION: ${{ env.GITHUB_ACTION }}
        GITHUB_JOB: ${{ env.GITHUB_JOB }}
      run: |
        python -m pip install -U PyYAML coveralls
        coveralls -v --service=github-actions
        echo "GITHUB_ACTION: $GITHUB_ACTION"
        echo "GITHUB_JOB: $GITHUB_JOB"
    - uses: FranzDiebold/github-env-vars-action@v2
    - name: Print environment variables exposed by this action
      run: |
        echo "CI_REPOSITORY_SLUG=$CI_REPOSITORY_SLUG"
        echo "CI_REPOSITORY_OWNER=$CI_REPOSITORY_OWNER"
        echo "CI_REPOSITORY_OWNER_SLUG=$CI_REPOSITORY_OWNER_SLUG"
        echo "CI_REPOSITORY_NAME=$CI_REPOSITORY_NAME"
        echo "CI_REPOSITORY_NAME_SLUG=$CI_REPOSITORY_NAME_SLUG"
        echo "CI_REPOSITORY=$CI_REPOSITORY"
        echo "CI_REF_SLUG=$CI_REF_SLUG"
        echo "CI_ACTION_REF_NAME=$CI_ACTION_REF_NAME"
        echo "CI_ACTION_REF_NAME_SLUG=$CI_ACTION_REF_NAME_SLUG"
        echo "CI_REF_NAME=$CI_REF_NAME"
        echo "CI_REF_NAME_SLUG=$CI_REF_NAME_SLUG"
        echo "CI_REF=$CI_REF"
        echo "CI_HEAD_REF_SLUG=$CI_HEAD_REF_SLUG"
        echo "CI_HEAD_REF=$CI_HEAD_REF"
        echo "CI_BASE_REF_SLUG=$CI_BASE_REF_SLUG"
        echo "CI_BASE_REF=$CI_BASE_REF"
        echo "CI_SHA_SHORT=$CI_SHA_SHORT"
        echo "CI_SHA=$CI_SHA"
        echo "CI_ACTOR=$CI_ACTOR"
        echo "CI_EVENT_NAME=$CI_EVENT_NAME"
        echo "CI_RUN_ID=$CI_RUN_ID"
        echo "CI_RUN_NUMBER=$CI_RUN_NUMBER"
        echo "CI_WORKFLOW=$CI_WORKFLOW"
        echo "CI_ACTION=$CI_ACTION"
    - name: Print environment variables exposed by GitHub
      run: |
        echo "GITHUB_ACTOR=$GITHUB_ACTOR"
        echo "GITHUB_REPOSITORY=$GITHUB_REPOSITORY"
        echo "GITHUB_SHA=$GITHUB_SHA"
        echo "GITHUB_REF=$GITHUB_REF"
        echo "GITHUB_HEAD_REF=$GITHUB_HEAD_REF"
        echo "GITHUB_BASE_REF=$GITHUB_BASE_REF"
        echo "GITHUB_EVENT_NAME=$GITHUB_EVENT_NAME"
        echo "GITHUB_RUN_ID=$GITHUB_RUN_ID"
        echo "GITHUB_RUN_NUMBER=$GITHUB_RUN_NUMBER"
        echo "GITHUB_WORKFLOW=$GITHUB_WORKFLOW"
        echo "GITHUB_ACTION=$GITHUB_ACTION"
    - name: Obtain Workflow Job ID from Workflow Jobs API endpoint
      uses: octokit/request-action@v2.x
      id: current_job_id
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_ID: ${{ env.GITHUB_RUN_ID }}
      with:
        route: GET /repos/{owner}/{repo}/actions/runs/{run_id}/jobs/{job}
        owner: afinetooth
        repo: flask-rollup
        run_id: ${{ github.run_id }}
        job: ${{ github.job }}
    - run: "echo current job ID: ${{ steps.current_job_id.outputs.data }}"
